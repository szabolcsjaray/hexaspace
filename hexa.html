<!DOCTYPE html>
<html>
    <head>
        <script src="jscolor.js"></script>
        <script lang="javascript">

            function el(id) {
                return document.getElementById(id);
            }

            var d = 4;
            var drawform;

            function setParameters() {
                    d=parseInt(el("input_d").value);
                    COLSTEP = parseInt(el("grstep").value);
                    MAXNUM = parseInt(el("random").value);
                    drawform = el("drawform").value;
                    circleNum = parseInt(el("circlenum").value);
                    circleRad = parseInt(el("circlerad").value);
                    DRAWSTEPNUM = parseInt(el("grspeed").value);
                    SPIRAL_STEP = parseFloat(el("spiralstep").value);
            }

            const HEIGHT = 1000;
            const WIDTH = 1000;
            var dh;
            var H;
            var W;
            //console.log("dh:"+dh);
            var context;
            function drawTriangle(x, y, color, n) {
                let x0 = Math.round((x-1)*d/2);
                let y0 = Math.round(y*dh);
                //console.log("n:" + n +"  x:"+x+",y:"+y+",x0:"+x0+",y0:"+y0);
                context.fillStyle = color;
                context.beginPath();
                if ((x+y)%2==0) {
                    context.moveTo(x0,y0);
                    context.lineTo(x0+d, y0);
                    context.lineTo(x0+d/2, y0-dh-1);
                    context.lineTo(x0, y0);
                    context.fill();
                    /*context.fillStyle = "black";
                    context.fillText(""+n, x0+d/2, y0-dh/2);*/
                    //console.log("down");
                } else {
                    context.moveTo(x0,y0-dh-1);
                    context.lineTo(x0+d, y0-dh-1);
                    context.lineTo(x0+d/2, y0);
                    context.lineTo(x0, y0-dh-1);
                    context.fill();
                    /*context.fillStyle = "black";
                    context.fillText(""+n, x0+d/2, y0-dh/2);*/
                    //console.log("up");

                }
            }
            var triangles = []; //[[W, Math.round(H/2)]];
            var walls = [];
            var points = [];

            function addToWalls(ti, notThis) {
                if (triangles.length>ti) {
                    for (let j=1;j<4;j++) {
                        if (j!=notThis) {
                            var newW = [triangles[ti][0], triangles[ti][1], j, ti];
                            walls.push(newW);
                        }
                    }
                }
            }

            function drawNode(x, y, col) {
                let x0 = x *d/2;
                let y0 = (y)*dh;
                context.beginPath();
                if (col!=null) {
                    context.fillStyle=col;
                }
                context.rect(x0-5, y0-5, 10, 10);
                context.fill();
            }
            function addPoint(xv,yv) {
                points[yv][xv] = 1;
            }
            function addAllPoints(ta) {
                if ((ta[0]+ta[1])%2==1) {
                    addPoint(ta[0], ta[1]-1);
                    addPoint(ta[0]+2, ta[1]-1);
                    addPoint(ta[0]+1, ta[1]);
                } else {
                    addPoint(ta[0], ta[1]);
                    addPoint(ta[0]+1, ta[1]-1);
                    addPoint(ta[0]+2, ta[1]);

                }
                //console.log("addAllPoints, points:" + points);
            }
            function notInPoints(x,y) {
                if (x<0 || y<0 ) return false;
                return (points[y][x]==0);
                /*
                for(let i=0;i<points.length;i++) {
                    if (points[i].x==x && points[i].y==y) {
                        return false;
                    }
                }
                return true;*/
            }

            function addIfNotThere(x, y) {
                if(x>0 && y<H && x<(W+2)*2 && y>0) {
                    for (let i=0;i<triangles.length;i++) {
                        if (triangles[i][0]==x && triangles[i][1]==y) {
                            return;
                        }
                    }
                    triangles.push([x,y,1]);
                }
            }
            var COL0 = [0,100,255];
            var COL1 = [255,0,0];
            var COLSTEP = 300;
            var OFFSMULT = 10;
            var MAXNUM = 8;
            var circleNum = 8;
            var SPIRAL_STEP = 0.3;

            var cols = [];
            const hexDigits = "0123456789ABCDEFF";

            function hex(d) {
                return hexDigits[Math.round(d/16)]+hexDigits[d%16];
            }

            function initCols() {
                cols = [];
                for(let i=0;i<=COLSTEP;i++) {
                    let c0 = Math.round(COL0[0]*(COLSTEP-i)/COLSTEP + COL1[0]*i/COLSTEP);
                    let c1 = Math.round(COL0[1]*(COLSTEP-i)/COLSTEP + COL1[1]*i/COLSTEP);
                    let c2 = Math.round(COL0[2]*(COLSTEP-i)/COLSTEP + COL1[2]*i/COLSTEP);
                    //console.log(c0+","+c1+","+c2);
                    //console.log(hex(c0)+","+hex(c1)+","+hex(c2));
                    cols.push("#"+hex(c0)+hex(c1)+hex(c2));
                }
            }

            function colF(gen,offs) {
                return cols[(gen+offs*OFFSMULT)%(COLSTEP+1)];
            }

            function initPoints() {
                points = [];
                for(let y=0;y<=H+1;y++) {
                    let row = new Array();
                    for(let x=0;x<=(W+2)*2;x++) {
                        row.push(0);
                    }
                    points.push(row);
                }
                //console.log(points);
            }
            var bgCols=["yellow", "lightgreen"];

            function colToArray(colStr, colArr) {
                colArr.length = 0;
                colArr.push(parseInt(""+colStr[0]+colStr[1], 16));
                colArr.push(parseInt(""+colStr[2]+colStr[3], 16));
                colArr.push(parseInt(""+colStr[4]+colStr[5], 16));
            }

            function setColors() {
                bgCols[0] = "#" + el("bgcol1").value;
                bgCols[1] = "#" + el("bgcol2").value;
                let gc1 = el("grcol1").value;
                colToArray(gc1, COL0);
                let gc2 = el("grcol2").value;
                colToArray(gc2, COL1);
            }

            function saveImage() {
                var link = document.getElementById('link');
                link.setAttribute('download', 'hexa.png');
                link.setAttribute('href', el("hexa").toDataURL("image/png").replace("image/png", "image/octet-stream"));
                link.click();
            }

            function drawNextStep() {
                    window.requestAnimationFrame(drawStep);
            }
            var DRAWSTEPNUM = 10;

            function drawStep() {
                let step = 0;
                while (walls.length>0 && step<DRAWSTEPNUM) {
                    let i = Math.floor(Math.random() * walls.length);
                    //console.log(i);
                    let p = (walls[i][0]+walls[i][1])%2;
                    if (walls[i][0] > 0 && walls[i][0] <= W*2 && walls[i][1] > 0 && walls[i][1] <= H) {
                        //console.log("tr.index from walls:" +walls[i][3] + "next gen:" + triangles[walls[i][3]][2]+1 +" wall i:" + i);
                        //console.log(walls[i]);
                        //console.log(triangles);
                        switch (walls[i][2]) {
                            case 1:
                                if (p==1) {
                                    if (notInPoints(walls[i][0]+1, walls[i][1]-2)) {
                                        triangles.push([walls[i][0],walls[i][1]-1, triangles[walls[i][3]][2]+1]);
                                        drawTriangle(walls[i][0],walls[i][1]-1, colF(triangles[walls[i][3]][2]+1, 0), 0);
                                        //drawTriangle(walls[i][0],walls[i][1]-1, upC, 0);
                                        //drawNode(walls[i][0]+1, walls[i][1]-2, "orange");
                                        addPoint(walls[i][0]+1, walls[i][1]-2);
                                        addToWalls(triangles.length-1, 1);
                                    }
                                } else {
                                    if (notInPoints(walls[i][0]+1, walls[i][1]+1)) {
                                        triangles.push([walls[i][0],walls[i][1]+1, triangles[walls[i][3]][2]+1]);
                                        drawTriangle(walls[i][0],walls[i][1]+1, colF(triangles[walls[i][3]][2]+1, 3), 0);
                                        //drawTriangle(walls[i][0],walls[i][1]+1, downC, 0);
                                        //drawNode(walls[i][0]+1, walls[i][1]+1, "orange");
                                        addPoint(walls[i][0]+1, walls[i][1]+1);
                                        addToWalls(triangles.length-1, 1);
                                    }
                                }
                                break;
                            case 2:
                                if (p==1) {
                                    if (notInPoints(walls[i][0]+3, walls[i][1])) {
                                        triangles.push([walls[i][0]+1,walls[i][1], triangles[walls[i][3]][2]+1]);
                                        drawTriangle(walls[i][0]+1,walls[i][1], colF(triangles[walls[i][3]][2]+1, 2), 0);
                                        //drawTriangle(walls[i][0]+1,walls[i][1], downRightC, 0);
                                        //drawNode(walls[i][0]+3, walls[i][1], "orange");
                                        addPoint(walls[i][0]+3, walls[i][1]);
                                        addToWalls(triangles.length-1, 3);
                                    }
                                } else {
                                    if (notInPoints(walls[i][0]+3, walls[i][1]-1)) {
                                        triangles.push([walls[i][0]+1,walls[i][1], triangles[walls[i][3]][2]+1]);
                                        drawTriangle(walls[i][0]+1,walls[i][1], colF(triangles[walls[i][3]][2]+1, 1), 0);
                                        //drawTriangle(walls[i][0]+1,walls[i][1], upRightC, 0);
                                        //drawNode(walls[i][0]+3, walls[i][1]-1, "yellow");
                                        addPoint(walls[i][0]+3, walls[i][1]-1);
                                        addToWalls(triangles.length-1, 3);
                                    }
                                }
                                break;
                            case 3:
                                if (p==1) {
                                    if (notInPoints(walls[i][0]-1, walls[i][1])) {
                                        triangles.push([walls[i][0]-1,walls[i][1], triangles[walls[i][3]][2]+1]);
                                        drawTriangle(walls[i][0]-1,walls[i][1], colF(triangles[walls[i][3]][2]+1, 4), 0);
                                        //drawTriangle(walls[i][0]-1,walls[i][1], downLeftC, 0);
                                        //drawNode(walls[i][0]-1, walls[i][1], "orange");
                                        addPoint(walls[i][0]-1, walls[i][1]);
                                        addToWalls(triangles.length-1, 2);
                                    }
                                } else {
                                    if (notInPoints(walls[i][0]-1, walls[i][1]-1)) {
                                        triangles.push([walls[i][0]-1,walls[i][1], triangles[walls[i][3]][2]+1]);
                                        drawTriangle(walls[i][0]-1,walls[i][1], colF(triangles[walls[i][3]][2]+1, 5), 0);
                                        //drawTriangle(walls[i][0]-1,walls[i][1], upLeftC, 0);
                                        //drawNode(walls[i][0]-1, walls[i][1]-1, "yellow");
                                        addPoint(walls[i][0]-1, walls[i][1]-1);
                                        addToWalls(triangles.length-1, 2);
                                    }
                                }
                                break;
                        }
                    }
                    walls.splice(i,1);
                    step++;
                }
                if (walls.length>0) {
                    setTimeout(drawNextStep, 10);
                }
            }

            const upC = "orange";
            const downC = "blue";
            const upRightC = "green";
            const upLeftC = "red";
            const downRightC = "yellow";
            const downLeftC = "purple";

            function startIt() {
                console.log("startIt d=" + d);

                //let bgCols=["#EFDFEF", "#AFFFFF"];
                setParameters();
                dh = d*Math.sqrt(3)/2;
                H = Math.round(HEIGHT/dh);
                W = Math.round(WIDTH/d);
                initPoints();
                walls = [];
                triangles = [];
                setColors();
                initCols();

                let hexaEl = el("hexa");
                context = hexaEl.getContext("2d");
                context.clearRect(0, 0, hexaEl.width, hexaEl.height);
                context.textAlign = "center";
                let n = 1;
                for(let i=0;i<W*2+1;i+=1) {
                    for (let j=0;j<H+1;j++) {

                        drawTriangle(i,j, bgCols[(i+j)%2], "("+i+","+j+")");
                    }
                }
                let RX, RY, fi;


                switch (drawform) {
                    case "circle" :
                        RX = W / 2 * circleRad / 100;
                        RY = H / 2 / 2 * circleRad / 100;
                        for(let fi=0;fi<2*Math.PI;fi+=2*Math.PI/circleNum) {
                            let xfi = Math.round(W + Math.cos(fi)*RX);
                            let yfi = Math.round(H / 2 + Math.sin(fi)*RY);

                            addIfNotThere(xfi, yfi);
                        }
                        break;
                    case "spiral" :
                        RX = W / 6 * circleRad / 100;
                        RY = H / 6 / 2 * circleRad / 100;
                        for(let fi=0;fi<=12*Math.PI;fi+=SPIRAL_STEP) {
                            let xfi = Math.round(W + Math.cos(fi)*RX*fi);
                            let yfi = Math.round(H / 2 + Math.sin(fi)*RY*fi);

                            addIfNotThere(xfi, yfi);
                        }
                        break;
                    case "one" :
                        addIfNotThere(Math.round(W), Math.round(H/2));
                        break;
                    case "randomroot" :
                        for(let i=0;i<MAXNUM;i++) {
                            addIfNotThere(Math.round(Math.random()*W*2), Math.round(Math.random()*H));
                        }
                       break;
                }

                for (let ti=0;ti<triangles.length;ti++) {
                    drawTriangle(triangles[ti][0], triangles[ti][1], "black");
                    addToWalls(ti,4);
                    addAllPoints(triangles[ti]);

                }

                drawStep();

                console.log("ready number of triangles:" + triangles.length);
            }

            function synchnum(el) {
                    document.getElementById(el.id + "n").value = el.value;
                }
            function synchslide(el, min, max) {
                if (el.value<min) el.value=min;
                if (el.value>max) el.value=max;
                let slEl = document.getElementById(el.id.substr(0, el.id.length - 1));
                slEl.value = el.value;
            }
            function copyValue( fromId, toId) {
                el(toId).jscolor.fromString(el(fromId).value);
            }
            function setParameterVisibility(param, visible) {
                let parameterEls = document.getElementsByClassName(param);
                if (parameterEls==null || parameterEls.length==0) {
                    return;
                }
                for (let i=0;i<parameterEls.length;i++) {
                    parameterEls[i].style.display = visible;
                }
            }
            function hideAllFormParameters() {
                let params = ["one","randomroot","circle","spiral"];
                params.forEach( function (item, index) { setParameterVisibility(item, "none"); });
            }
            function showHideFormParameters() {
                hideAllFormParameters();
                setParameterVisibility(el("drawform").value, "table-row");
            }
        </script>
    </head>
    <body  style="background-color: #A0A0A0;" onload="showHideFormParameters();">
        <table>

            <tbody>
                <tr>
                    <td>
                            <canvas id="hexa" width="1000" height="1000">
                            </canvas>
                    </td>
                    <td>
                        <table>
                                <thead>
                                        <th>
                                                HEXA SPACE
                                        </th>
                                    </thead>
                                                                <tbody>
                                <tr>
                                    <td>
                                        Triangle size:</td><td> <input type="number" id="input_dn" value="5" onchange="synchslide(this,2,100);"/>
                                        2 <input type="range" min="2" max="100" value="5" oninput="synchnum(this);" id="input_d"> 100
                                    </td>
                                </tr>
                                <tr>
                                    <td>Draw form: </td>
                                    <td>
                                        <select name="drawformname" id="drawform" onchange="showHideFormParameters();">
                                            <option value="one">One root</option>
                                            <option value="randomroot">Random roots</option>
                                            <option value="circle">Circle</option>
                                            <option value="spiral">Spiral</option>
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>BG color 1: </td><td> <input id="bgcol1" class="jscolor" value="000000"></td>
                                </tr>
                                <tr>
                                    <td>BG color 2: </td><td> <input id="bgcol2" class="jscolor" value="000010"> <button title="Same" onclick="copyValue( 'bgcol1', 'bgcol2');">Same</button></td>
                                </tr>
                                <tr>
                                    <td>Grow color 1: </td><td> <input id="grcol1" class="jscolor" value="F00000"></td>
                                </tr>
                                <tr>
                                    <td>Grow color 2: </td><td> <input id="grcol2" class="jscolor" value="00F000"> <button title="Same" onclick="copyValue('grcol1', 'grcol2');">Same</button></td>
                                </tr>
                                <tr>
                                    <td>Grow color step: </td><td> <input id="grstepn" type="number" value="100" onchange="synchslide(this,2,1000);"/>
                                        2 <input type="range" min="2" max="1000" value="100" oninput="synchnum(this);" id="grstep"> 1000</td>
                                </tr>
                                <tr>
                                    <td>Grow speed: </td><td> <input id="grspeedn" type="number" value="100" onchange="synchslide(this,1,3000);"/>
                                        1 <input type="range" min="1" max="3000" value="100" oninput="synchnum(this);" id="grspeed"> 3000</td>
                                </tr>
                                <tr class="randomroot">
                                    <td>Random num: </td><td> <input id="randomn" type="number" value="10" onchange="synchslide(this,1,1000);"/>
                                        1 <input type="range" min="1" max="1000" value="10" oninput="synchnum(this);" id="random"> 1000</td>
                                </tr>
                                <tr class="circle">
                                        <td>Circle num: </td><td> <input id="circlenumn" type="number" value="8" onchange="synchslide(this,1,1000);"/>
                                            1 <input type="range" min="1" max="1000" value="10" oninput="synchnum(this);" id="circlenum"> 1000</td>
                                </tr>
                                <tr class="circle spiral">
                                        <td>Circle/spiral radius %: </td><td> <input id="circleradn" type="number" value="100" onchange="synchslide(this,1,200);"/>
                                            1% <input type="range" min="1" max="200" value="100" oninput="synchnum(this);" id="circlerad"> 200%</td>
                                </tr>
                                <tr class="spiral">
                                    <td>Spiral step angle: </td><td> <input id="spiralstepn" type="number" value="0.3" step="0.01" onchange="synchslide(this,0.02,3);"/>
                                        0.02 <input type="range" min="0.02" max="3" value="0.3" step="0.01" oninput="synchnum(this);" id="spiralstep"> 3</td>
                               </tr>
                                <tr>
                                    <td colspan="2">
                                        <button title="Redraw" onclick="startIt();">Redraw</button>
                                        <button title="Save" onclick="saveImage();">Save</button>
                                        <a id="link"></a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>
        </table>

    </body>
</html>